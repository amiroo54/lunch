{% extends "base.html" %}

{% block title %}Ù†ÙˆØ¨Øª Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ{% endblock %}

{% block body %}
<div class="container">
    <div class="nav">
        <a href="{{ url_for('index') }}">Ø®Ø§Ù†Ù‡</a> |
        <a href="{{ url_for('logout') }}">Ø®Ø±ÙˆØ¬</a>
    </div>

    <h1>ğŸ¥¤ Ù†ÙˆØ¨Øª Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ - {{ today }}</h1>

    {% if next_payer_user %}
    <div class="card next-payer">
        <p>Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ø¨Ø®Ø±Ø¯:</p>
        <h2>{{ next_payer_user.display_name }}</h2>
    </div>
    {% else %}
    <div class="card">
        <p>Ø­Ø¶ÙˆØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø§ÙØ±Ø§Ø¯ Ø­Ø§Ø¶Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
    </div>
    {% endif %}

    <div class="card">
        <h2>Ø­Ø¶ÙˆØ± Ø§Ù…Ø±ÙˆØ²</h2>
        <p>Ø§ÙØ±Ø§Ø¯ÛŒ Ú©Ù‡ Ø§Ù…Ø±ÙˆØ² Ù†Ø§Ù‡Ø§Ø± Ø¨ÙˆØ¯Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
        <ul class="user-list">
            {% for user in all_users %}
            <li class="user-item {% if user.id in attendee_ids %}attending{% endif %}">
                <span>
                    {{ user.display_name }}
                    <span class="stats">
                        (Ù¾Ø±Ø¯Ø§Ø®Øª: {{ stats.get(user.id, {}).get('paid', 0) }} | Ù†ÙˆØ´ÛŒØ¯: {{ stats.get(user.id, {}).get('drank', 0) }})
                    </span>
                </span>
                <span>
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="action" value="toggle_attendance">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        {% if user.id in attendee_ids %}
                        <button type="submit" class="btn-remove">Ø­Ø°Ù</button>
                        {% else %}
                        <button type="submit" class="btn-attend">Ø­Ø§Ø¶Ø±</button>
                        {% endif %}
                    </form>
                    {% if user.id in attendee_ids %}
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="action" value="set_payer">
                        <input type="hidden" name="payer_id" value="{{ user.id }}">
                        <button type="submit" class="btn-pay">Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯</button>
                    </form>
                    {% endif %}
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>

    {% if event and event.payer_id %}
    <div class="card">
        <h3>âœ… Ø§Ù…Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯ ØªÙˆØ³Ø·: {{ event.payer_name if event.payer_name else 'Ù†Ø§Ù…Ø´Ø®Øµ' }}</h3>
    </div>
    {% endif %}

    <div class="card">
        <h2>Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
        <table>
            <thead>
                <tr>
                    <th>Ù†Ø§Ù…</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯ Ù†ÙˆØ´ÛŒØ¯Ù†</th>
                    <th>Ù†Ø³Ø¨Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for user in all_users %}
                {% set user_stats = stats.get(user.id, {'paid': 0, 'drank': 0}) %}
                {% set ratio = (user_stats.paid / user_stats.drank) if user_stats.drank > 0 else 0 %}
                <tr>
                    <td>{{ user.display_name }}</td>
                    <td>{{ user_stats.paid }}</td>
                    <td>{{ user_stats.drank }}</td>
                    <td class="ratio {% if ratio < 0.5 and user_stats.drank > 0 %}low-ratio{% endif %}">
                        {{ "%.2f"|format(ratio) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ÛŒØ±</h2>
        <table>
            <thead>
                <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</th>
                </tr>
            </thead>
            <tbody>
                {% for e in recent_events %}
                <tr>
                    <td>{{ e.event_date }}</td>
                    <td>{{ e.payer_name if e.payer_name else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
