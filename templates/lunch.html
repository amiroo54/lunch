{% extends "base.html" %}

{% block title %}Drinks Tracker{% endblock %}

{% block body %}
<div class="container">
    <div class="nav">
        <a href="{{ url_for('index') }}">Home</a> |
        <a href="{{ url_for('logout') }}">Logout</a>
    </div>

    <h1>ðŸ¥¤ Drinks Tracker - {{ today }}</h1>

    {% if next_payer_user %}
    <div class="card next-payer">
        <p>Next person to buy drinks:</p>
        <h2>{{ next_payer_user.display_name }}</h2>
    </div>
    {% else %}
    <div class="card">
        <p>No attendance recorded. Please select the people who are present.</p>
    </div>
    {% endif %}

    <div class="card">
        <h2>Today's Attendance</h2>
        <p>Select who was at lunch today:</p>
        <ul class="user-list">
            {% for user in all_users %}
            <li class="user-item {% if user.id in attendee_ids %}attending{% endif %}">
                <span>
                    {{ user.display_name }}
                    <span class="stats">
                        (Paid: {{ stats.get(user.id, {}).get('paid', 0) }} | Drank: {{ stats.get(user.id, {}).get('drank', 0) }})
                    </span>
                </span>
                <span>
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="action" value="toggle_attendance">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        {% if user.id in attendee_ids %}
                        <button type="submit" class="btn-remove">Remove</button>
                        {% else %}
                        <button type="submit" class="btn-attend">Present</button>
                        {% endif %}
                    </form>
                    {% if user.id in attendee_ids %}
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="action" value="set_payer">
                        <input type="hidden" name="payer_id" value="{{ user.id }}">
                        <button type="submit" class="btn-pay">Paid</button>
                    </form>
                    {% endif %}
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>

    {% if event and event.payer_id %}
    <div class="card">
        <h3>âœ… Today's payer: {{ event.payer_name if event.payer_name else 'Unknown' }}</h3>
    </div>
    {% endif %}

    <div class="card">
        <h2>User Statistics</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Times Paid</th>
                    <th>Times Drank</th>
                    <th>Ratio</th>
                </tr>
            </thead>
            <tbody>
                {% for user in all_users %}
                {% set user_stats = stats.get(user.id, {'paid': 0, 'drank': 0}) %}
                {% set ratio = (user_stats.paid / user_stats.drank) if user_stats.drank > 0 else 0 %}
                <tr>
                    <td>{{ user.display_name }}</td>
                    <td>{{ user_stats.paid }}</td>
                    <td>{{ user_stats.drank }}</td>
                    <td class="ratio {% if ratio < 0.5 and user_stats.drank > 0 %}low-ratio{% endif %}">
                        {{ "%.2f"|format(ratio) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Recent History</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Payer</th>
                </tr>
            </thead>
            <tbody>
                {% for e in recent_events %}
                <tr>
                    <td>{{ e.event_date }}</td>
                    <td>{{ e.payer_name if e.payer_name else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
